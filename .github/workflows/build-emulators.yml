name: Build All Emulators ARM64

on:
  schedule:
    - cron: '0 4 * * 0'
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/build-emulators.yml'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up QEMU for ARM64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Fetch latest versions
        id: versions
        run: |
          # Azahar
          AZAHAR_TAG=$(curl -fsSL https://api.github.com/repos/azahar-emu/azahar/releases/latest | jq -r '.tag_name')
          echo "azahar_version=$AZAHAR_TAG" >> $GITHUB_OUTPUT

          # Dolphin
          DOLPHIN_COMMIT=$(curl -fsSL https://api.github.com/repos/dolphin-emu/dolphin/commits/master | jq -r '.sha')
          echo "dolphin_commit=$DOLPHIN_COMMIT" >> $GITHUB_OUTPUT
          echo "dolphin_short=${DOLPHIN_COMMIT:0:7}" >> $GITHUB_OUTPUT

          # DuckStation
          DUCK_COMMIT=$(curl -fsSL https://api.github.com/repos/stenzek/duckstation/commits/master | jq -r '.sha')
          echo "duck_commit=$DUCK_COMMIT" >> $GITHUB_OUTPUT
          echo "duck_short=${DUCK_COMMIT:0:7}" >> $GITHUB_OUTPUT

          # EmulationStation-DE
          ESDE_TAG=$(curl -fsSL "https://gitlab.com/api/v4/projects/es-de%2Femulationstation-de/releases" | jq -r '.[0].tag_name')
          echo "esde_version=$ESDE_TAG" >> $GITHUB_OUTPUT

          # melonDS
          MELON_TAG=$(curl -fsSL https://api.github.com/repos/melonDS-emu/melonDS/releases/latest | jq -r '.tag_name')
          echo "melonds_version=$MELON_TAG" >> $GITHUB_OUTPUT

          # PPSSPP
          PPSSPP_TAG=$(curl -fsSL https://api.github.com/repos/hrydgard/ppsspp/releases/latest | jq -r '.tag_name')
          echo "ppsspp_version=$PPSSPP_TAG" >> $GITHUB_OUTPUT

          # xemu
          XEMU_TAG=$(curl -fsSL https://api.github.com/repos/xemu-project/xemu/releases/latest | jq -r '.tag_name')
          echo "xemu_version=$XEMU_TAG" >> $GITHUB_OUTPUT

      - name: Create ARM64 container with all dependencies
        run: |
          docker run --name emu-builder --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -e AZAHAR_VERSION=${{ steps.versions.outputs.azahar_version }} \
            -e DOLPHIN_COMMIT=${{ steps.versions.outputs.dolphin_commit }} \
            -e DOLPHIN_SHORT=${{ steps.versions.outputs.dolphin_short }} \
            -e DUCK_COMMIT=${{ steps.versions.outputs.duck_commit }} \
            -e DUCK_SHORT=${{ steps.versions.outputs.duck_short }} \
            -e ESDE_VERSION=${{ steps.versions.outputs.esde_version }} \
            -e MELONDS_VERSION=${{ steps.versions.outputs.melonds_version }} \
            -e PPSSPP_VERSION=${{ steps.versions.outputs.ppsspp_version }} \
            -e XEMU_VERSION=${{ steps.versions.outputs.xemu_version }} \
            ubuntu:24.04 bash -c '
              set -e
              export DEBIAN_FRONTEND=noninteractive

              echo "=== Installing all build dependencies ==="
              apt-get update
              apt-get install -y \
                build-essential cmake ninja-build git pkg-config meson dpkg-dev \
                clang llvm libc++-dev libc++abi-dev \
                python3 python3-pip python3-yaml \
                libjemalloc-dev libwayland-dev \
                qt6-base-dev qt6-base-private-dev qt6-multimedia-dev qt6-tools-dev \
                libqt6opengl6-dev libqt6svg6-dev \
                libsdl2-dev libsdl2-ttf-dev \
                libavcodec-dev libavformat-dev libavutil-dev libswscale-dev \
                libssl-dev libcurl4-openssl-dev \
                libfmt-dev libzstd-dev libpng-dev liblz4-dev libbz2-dev \
                libpugixml-dev nlohmann-json3-dev \
                libusb-1.0-0-dev libhidapi-dev libevdev-dev \
                libspeexdsp-dev glslang-tools spirv-tools \
                libboost-serialization-dev libcubeb-dev libenet-dev \
                libsfml-dev libminiupnpc-dev libmbedtls-dev \
                libsystemd-dev libbluetooth-dev libasound2-dev libpulse-dev \
                liblzo2-dev libxxhash-dev libspng-dev \
                extra-cmake-modules \
                libslirp-dev libarchive-dev \
                libglew-dev libsnappy-dev libzip-dev \
                libfreeimage-dev libfreetype-dev libvlc-dev libpoppler-cpp-dev \
                libepoxy-dev libpixman-1-dev libgtk-3-dev \
                libsamplerate0-dev libpcap-dev libglib2.0-dev

              echo "=== Cloning all repositories ==="

              # Azahar
              git clone --depth 1 --branch "$AZAHAR_VERSION" --recurse-submodules \
                https://github.com/azahar-emu/azahar.git /src/azahar

              # Dolphin
              git clone https://github.com/dolphin-emu/dolphin.git /src/dolphin
              cd /src/dolphin && git checkout "$DOLPHIN_COMMIT" && git submodule update --init --recursive

              # DuckStation
              git clone https://github.com/stenzek/duckstation.git /src/duckstation
              cd /src/duckstation && git checkout "$DUCK_COMMIT" && git submodule update --init --recursive

              # EmulationStation-DE
              git clone --depth 1 --branch "$ESDE_VERSION" \
                https://gitlab.com/es-de/emulationstation-de.git /src/esde

              # melonDS
              git clone --depth 1 --branch "$MELONDS_VERSION" \
                https://github.com/melonDS-emu/melonDS.git /src/melonds

              # PPSSPP
              git clone --depth 1 --branch "$PPSSPP_VERSION" --recurse-submodules \
                https://github.com/hrydgard/ppsspp.git /src/ppsspp

              # xemu
              git clone --depth 1 --branch "$XEMU_VERSION" \
                https://github.com/xemu-project/xemu.git /src/xemu
              cd /src/xemu && git submodule update --init --recursive

              echo "=== Dependencies installed, repos cloned ==="
            '
          docker commit emu-builder emu-builder-image
          docker rm emu-builder

      # =========================================================================
      # BUILD STEPS
      # =========================================================================

      - name: Build Azahar
        continue-on-error: true
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            emu-builder-image bash -c '
              set -e
              echo "=== Building Azahar ==="
              cd /src/azahar
              mkdir -p build && cd build
              cmake .. -G Ninja \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=/usr \
                -DCMAKE_CXX_COMPILER=clang++ \
                -DCMAKE_C_COMPILER=clang \
                -DCMAKE_C_FLAGS="-O3 -flto=thin -march=armv8-a+crc+simd -mtune=cortex-a57" \
                -DCMAKE_CXX_FLAGS="-O3 -flto=thin -march=armv8-a+crc+simd -mtune=cortex-a57" \
                -DCMAKE_EXE_LINKER_FLAGS="-ljemalloc" \
                -DCMAKE_SHARED_LINKER_FLAGS="-ljemalloc" \
                -DENABLE_VULKAN=ON \
                -DENABLE_OPENGL=ON \
                -DENABLE_QT_GUI=ON \
                -DENABLE_SDL2_FRONTEND=ON \
                -DENABLE_TESTS=OFF \
                -DENABLE_WEB_SERVICE=OFF \
                -DENABLE_X11=OFF
              ninja -j$(nproc)
              DESTDIR=/pkg/azahar ninja install
            '
          docker commit $(docker ps -lq) emu-builder-image

      - name: Build Dolphin
        continue-on-error: true
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            emu-builder-image bash -c '
              set -e
              echo "=== Building Dolphin ==="
              cd /src/dolphin
              mkdir -p build && cd build
              cmake .. -G Ninja \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=/usr \
                -DCMAKE_C_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57" \
                -DCMAKE_CXX_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57" \
                -DCMAKE_EXE_LINKER_FLAGS="-ljemalloc" \
                -DCMAKE_SHARED_LINKER_FLAGS="-ljemalloc" \
                -DENABLE_VULKAN=ON \
                -DENABLE_X11=OFF \
                -DENABLE_WAYLAND=ON \
                -DENABLE_TESTS=OFF \
                -DENABLE_ANALYTICS=OFF
              ninja -j$(nproc)
              DESTDIR=/pkg/dolphin ninja install
            '
          docker commit $(docker ps -lq) emu-builder-image

      - name: Build DuckStation
        continue-on-error: true
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            emu-builder-image bash -c '
              set -e
              echo "=== Building DuckStation ==="
              cd /src/duckstation
              mkdir -p build && cd build
              cmake .. -G Ninja \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=/usr \
                -DCMAKE_C_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57" \
                -DCMAKE_CXX_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57" \
                -DCMAKE_EXE_LINKER_FLAGS="-ljemalloc" \
                -DCMAKE_SHARED_LINKER_FLAGS="-ljemalloc" \
                -DBUILD_QT_FRONTEND=ON \
                -DBUILD_NOGUI_FRONTEND=OFF \
                -DENABLE_WAYLAND=ON \
                -DENABLE_X11=OFF
              ninja -j$(nproc)
              DESTDIR=/pkg/duckstation ninja install
            '
          docker commit $(docker ps -lq) emu-builder-image

      - name: Build EmulationStation-DE
        continue-on-error: true
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            emu-builder-image bash -c '
              set -e
              echo "=== Building EmulationStation-DE ==="
              cd /src/esde
              mkdir -p build && cd build
              cmake .. -G Ninja \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=/usr \
                -DCMAKE_C_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57" \
                -DCMAKE_CXX_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57"
              ninja -j$(nproc)
              DESTDIR=/pkg/esde ninja install
            '
          docker commit $(docker ps -lq) emu-builder-image

      - name: Build melonDS
        continue-on-error: true
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            emu-builder-image bash -c '
              set -e
              echo "=== Building melonDS ==="
              cd /src/melonds
              mkdir -p build && cd build
              cmake .. -G Ninja \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=/usr \
                -DCMAKE_C_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57" \
                -DCMAKE_CXX_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57" \
                -DCMAKE_EXE_LINKER_FLAGS="-ljemalloc" \
                -DCMAKE_SHARED_LINKER_FLAGS="-ljemalloc" \
                -DENABLE_WAYLAND=ON
              ninja -j$(nproc)
              DESTDIR=/pkg/melonds ninja install
            '
          docker commit $(docker ps -lq) emu-builder-image

      - name: Build PPSSPP
        continue-on-error: true
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            emu-builder-image bash -c '
              set -e
              echo "=== Building PPSSPP ==="
              cd /src/ppsspp
              mkdir -p build && cd build
              cmake .. -G Ninja \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=/usr \
                -DCMAKE_C_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57" \
                -DCMAKE_CXX_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57" \
                -DCMAKE_EXE_LINKER_FLAGS="-ljemalloc" \
                -DCMAKE_SHARED_LINKER_FLAGS="-ljemalloc" \
                -DUSING_QT_UI=OFF \
                -DHEADLESS=OFF \
                -DUSE_WAYLAND_WSI=ON \
                -DVULKAN=ON
              ninja -j$(nproc)

              mkdir -p /pkg/ppsspp/usr/bin /pkg/ppsspp/usr/share/applications /pkg/ppsspp/usr/share/ppsspp
              cp PPSSPPSDL /pkg/ppsspp/usr/bin/ppsspp
              cp -r ../assets /pkg/ppsspp/usr/share/ppsspp/

              cat > /pkg/ppsspp/usr/share/applications/ppsspp.desktop << DESK
          [Desktop Entry]
          Name=PPSSPP
          Comment=PlayStation Portable Emulator
          Exec=ppsspp
          Icon=ppsspp
          Terminal=false
          Type=Application
          Categories=Game;Emulator;
          DESK
            '
          docker commit $(docker ps -lq) emu-builder-image

      - name: Build xemu
        continue-on-error: true
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            emu-builder-image bash -c '
              set -e
              echo "=== Building xemu ==="
              cd /src/xemu
              export CFLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57"
              export CXXFLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57"
              export LDFLAGS="-ljemalloc"
              ./build.sh

              mkdir -p /pkg/xemu/usr/bin /pkg/xemu/usr/share/applications
              cp dist/xemu /pkg/xemu/usr/bin/

              cat > /pkg/xemu/usr/share/applications/xemu.desktop << DESK
          [Desktop Entry]
          Name=xemu
          Comment=Original Xbox Emulator
          Exec=xemu
          Icon=xemu
          Terminal=false
          Type=Application
          Categories=Game;Emulator;
          DESK
            '
          docker commit $(docker ps -lq) emu-builder-image

      # =========================================================================
      # PACKAGE ALL DEBS
      # =========================================================================

      - name: Package all .deb files
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -e AZAHAR_VERSION=${{ steps.versions.outputs.azahar_version }} \
            -e DOLPHIN_SHORT=${{ steps.versions.outputs.dolphin_short }} \
            -e DUCK_SHORT=${{ steps.versions.outputs.duck_short }} \
            -e ESDE_VERSION=${{ steps.versions.outputs.esde_version }} \
            -e MELONDS_VERSION=${{ steps.versions.outputs.melonds_version }} \
            -e PPSSPP_VERSION=${{ steps.versions.outputs.ppsspp_version }} \
            -e XEMU_VERSION=${{ steps.versions.outputs.xemu_version }} \
            emu-builder-image bash -c '
              echo "=== Packaging .deb files for successful builds ==="

              # Azahar
              if [ -d /pkg/azahar/usr ]; then
                AZAHAR_CLEAN=$(echo "$AZAHAR_VERSION" | sed "s/^v//")
                mkdir -p /pkg/azahar/DEBIAN
                cat > /pkg/azahar/DEBIAN/control << EOF
          Package: azahar-emu-l4t
          Version: ${AZAHAR_CLEAN}
          Architecture: arm64
          Maintainer: Ethiquema <noreply@ethiquema.github.io>
          Depends: libc6, libjemalloc2, libqt6widgets6, libqt6gui6, libqt6core6, libqt6multimedia6, libqt6opengl6, libsdl2-2.0-0, libssl3t64, libavcodec60, libavformat60, libswscale7, libspeexdsp1, libfmt9, libzstd1, libusb-1.0-0, libhidapi-hidraw0, libboost-serialization1.83.0, libenet7, liblz4-1
          Provides: citra
          Replaces: citra
          Section: games
          Priority: optional
          Description: Azahar 3DS Emulator (ARM64 L4T build)
           Optimized for Nintendo Switch with Vulkan support.
          EOF
                dpkg-deb --build /pkg/azahar /workspace/azahar-emu-l4t_${AZAHAR_CLEAN}_arm64.deb
                echo "✓ Azahar packaged"
              else
                echo "✗ Azahar build not found, skipping"
              fi

              # Dolphin
              if [ -d /pkg/dolphin/usr ]; then
                DOLPHIN_PKG="0.0.0+git.${DOLPHIN_SHORT}"
                mkdir -p /pkg/dolphin/DEBIAN
                cat > /pkg/dolphin/DEBIAN/control << EOF
          Package: dolphin-emu-l4t
          Version: ${DOLPHIN_PKG}
          Architecture: arm64
          Maintainer: Ethiquema <noreply@ethiquema.github.io>
          Depends: libc6, libjemalloc2, libqt6widgets6, libqt6gui6, libqt6core6, libavcodec60, libavformat60, libswscale7, libevdev2, libminiupnpc17, libmbedtls21, libcurl4t64, libhidapi-hidraw0, libsystemd0, libbluetooth3, libasound2t64, libpulse0, libpugixml1v5, libbz2-1.0, libzstd1, liblzo2-2, libpng16-16t64, libusb-1.0-0, libfmt9, libsfml-system2.6, libsfml-network2.6, libxxhash0, libspng0
          Section: games
          Priority: optional
          Description: Dolphin GameCube/Wii Emulator (ARM64 L4T build)
           Optimized for Nintendo Switch with Vulkan/Wayland support.
          EOF
                dpkg-deb --build /pkg/dolphin /workspace/dolphin-emu-l4t_${DOLPHIN_PKG}_arm64.deb
                echo "✓ Dolphin packaged"
              else
                echo "✗ Dolphin build not found, skipping"
              fi

              # DuckStation
              if [ -d /pkg/duckstation/usr ]; then
                DUCK_PKG="0.0.0+git.${DUCK_SHORT}"
                mkdir -p /pkg/duckstation/DEBIAN
                cat > /pkg/duckstation/DEBIAN/control << EOF
          Package: duckstation-l4t
          Version: ${DUCK_PKG}
          Architecture: arm64
          Maintainer: Ethiquema <noreply@ethiquema.github.io>
          Depends: libc6, libjemalloc2, libqt6widgets6, libqt6gui6, libqt6core6, libsdl2-2.0-0, libcurl4t64
          Section: games
          Priority: optional
          Description: DuckStation PS1 Emulator (ARM64 L4T build)
           Optimized for Nintendo Switch with Vulkan support.
          EOF
                dpkg-deb --build /pkg/duckstation /workspace/duckstation-l4t_${DUCK_PKG}_arm64.deb
                echo "✓ DuckStation packaged"
              else
                echo "✗ DuckStation build not found, skipping"
              fi

              # EmulationStation-DE
              if [ -d /pkg/esde/usr ]; then
                ESDE_CLEAN=$(echo "$ESDE_VERSION" | sed "s/^v//")
                mkdir -p /pkg/esde/DEBIAN
                cat > /pkg/esde/DEBIAN/control << EOF
          Package: emulationstation-de-l4t
          Version: ${ESDE_CLEAN}
          Architecture: arm64
          Maintainer: Ethiquema <noreply@ethiquema.github.io>
          Depends: libc6, libsdl2-2.0-0, libavcodec60, libavformat60, libswscale7, libfreeimage3t64, libfreetype6, libcurl4t64, libpugixml1v5, libvlc5, libpoppler-cpp0t64
          Provides: emulationstation
          Conflicts: emulationstation
          Section: games
          Priority: optional
          Description: EmulationStation Desktop Edition (ARM64 L4T build)
           Optimized for Nintendo Switch.
          EOF
                dpkg-deb --build /pkg/esde /workspace/emulationstation-de-l4t_${ESDE_CLEAN}_arm64.deb
                echo "✓ EmulationStation-DE packaged"
              else
                echo "✗ EmulationStation-DE build not found, skipping"
              fi

              # melonDS
              if [ -d /pkg/melonds/usr ]; then
                MELONDS_CLEAN=$(echo "$MELONDS_VERSION" | sed "s/^v//")
                mkdir -p /pkg/melonds/DEBIAN
                cat > /pkg/melonds/DEBIAN/control << EOF
          Package: melonds-l4t
          Version: ${MELONDS_CLEAN}
          Architecture: arm64
          Maintainer: Ethiquema <noreply@ethiquema.github.io>
          Depends: libc6, libjemalloc2, libqt6widgets6, libqt6gui6, libqt6core6, libqt6multimedia6, libsdl2-2.0-0, libslirp0, libarchive13t64, libzstd1
          Section: games
          Priority: optional
          Description: melonDS Nintendo DS Emulator (ARM64 L4T build)
           Optimized for Nintendo Switch with OpenGL renderer.
          EOF
                dpkg-deb --build /pkg/melonds /workspace/melonds-l4t_${MELONDS_CLEAN}_arm64.deb
                echo "✓ melonDS packaged"
              else
                echo "✗ melonDS build not found, skipping"
              fi

              # PPSSPP
              if [ -d /pkg/ppsspp/usr ]; then
                PPSSPP_CLEAN=$(echo "$PPSSPP_VERSION" | sed "s/^v//")
                mkdir -p /pkg/ppsspp/DEBIAN
                cat > /pkg/ppsspp/DEBIAN/control << EOF
          Package: ppsspp-l4t
          Version: ${PPSSPP_CLEAN}
          Architecture: arm64
          Maintainer: Ethiquema <noreply@ethiquema.github.io>
          Depends: libc6, libjemalloc2, libsdl2-2.0-0, libsdl2-ttf-2.0-0, libglew2.2, libsnappy1v5, libavcodec60, libavformat60, libswscale7, libzip4t64, libpng16-16t64
          Provides: ppsspp
          Conflicts: ppsspp
          Section: games
          Priority: optional
          Description: PPSSPP PlayStation Portable Emulator (ARM64 L4T build)
           Optimized for Nintendo Switch with Vulkan support.
          EOF
                dpkg-deb --build /pkg/ppsspp /workspace/ppsspp-l4t_${PPSSPP_CLEAN}_arm64.deb
                echo "✓ PPSSPP packaged"
              else
                echo "✗ PPSSPP build not found, skipping"
              fi

              # xemu
              if [ -d /pkg/xemu/usr ]; then
                XEMU_CLEAN=$(echo "$XEMU_VERSION" | sed "s/^v//")
                mkdir -p /pkg/xemu/DEBIAN
                cat > /pkg/xemu/DEBIAN/control << EOF
          Package: xemu-l4t
          Version: ${XEMU_CLEAN}
          Architecture: arm64
          Maintainer: Ethiquema <noreply@ethiquema.github.io>
          Depends: libc6, libjemalloc2, libsdl2-2.0-0, libepoxy0, libpixman-1-0, libgtk-3-0t64, libssl3t64, libsamplerate0, libpcap0.8t64, libslirp0
          Section: games
          Priority: optional
          Description: xemu Original Xbox Emulator (ARM64 L4T build)
           Optimized for Nintendo Switch with Vulkan support.
          EOF
                dpkg-deb --build /pkg/xemu /workspace/xemu-l4t_${XEMU_CLEAN}_arm64.deb
                echo "✓ xemu packaged"
              else
                echo "✗ xemu build not found, skipping"
              fi

              echo "=== Packaging complete ==="
              ls -la /workspace/*.deb 2>/dev/null || echo "No packages were built"
            '

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: emulator-debs
          path: "*.deb"
          retention-days: 1

      - name: Save version trackers
        run: |
          echo "${{ steps.versions.outputs.azahar_version }}" > .azahar-version
          echo "${{ steps.versions.outputs.dolphin_commit }}" > .dolphin-commit
          echo "${{ steps.versions.outputs.duck_commit }}" > .duckstation-commit
          echo "${{ steps.versions.outputs.esde_version }}" > .esde-version
          echo "${{ steps.versions.outputs.melonds_version }}" > .melonds-version
          echo "${{ steps.versions.outputs.ppsspp_version }}" > .ppsspp-version
          echo "${{ steps.versions.outputs.xemu_version }}" > .xemu-version

  update-repo:
    needs: build
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: emulator-debs

      - name: Checkout gh-pages
        run: |
          git fetch origin gh-pages:gh-pages || true
          git worktree add gh-pages-dir gh-pages || {
            git worktree add --detach gh-pages-dir
            cd gh-pages-dir
            git checkout --orphan gh-pages
            git rm -rf . 2>/dev/null || true
            mkdir -p pool/main dists/noble/main/binary-arm64
            cd ..
          }

      - name: Install APT tools
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev apt-utils

      - name: Import GPG key
        run: |
          echo "${{ secrets.PRIVATE }}" | gpg --batch --import
          gpg --armor --export "Ethiquema L4T Repo" > gh-pages-dir/public.key

      - name: Add packages to pool
        run: |
          mkdir -p gh-pages-dir/pool/main
          cp *.deb gh-pages-dir/pool/main/ 2>/dev/null || echo "No new packages"

      - name: Regenerate APT repository metadata
        run: |
          cd gh-pages-dir
          mkdir -p dists/noble/main/binary-arm64

          dpkg-scanpackages --arch arm64 pool/ > dists/noble/main/binary-arm64/Packages
          gzip -k -f dists/noble/main/binary-arm64/Packages

          cd dists/noble
          cat > Release << EOF
          Origin: Ethiquema L4T Repository
          Label: l4t-debs
          Suite: noble
          Codename: noble
          Architectures: arm64
          Components: main
          Description: L4T packages for Nintendo Switch
          EOF

          apt-ftparchive release . >> Release
          rm -f Release.gpg InRelease
          gpg --batch --default-key "Ethiquema L4T Repo" -abs -o Release.gpg Release
          gpg --batch --default-key "Ethiquema L4T Repo" --clearsign -o InRelease Release

      - name: Deploy to gh-pages
        run: |
          cd gh-pages-dir
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Update APT repository" || echo "No changes"
          git push origin gh-pages

      - name: Save trackers to main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .*-version .*-commit 2>/dev/null || true
          git commit -m "Update version trackers" || echo "No changes"
          git push origin main
