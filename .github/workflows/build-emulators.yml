name: Build All Emulators ARM64

on:
  schedule:
    - cron: '0 4 * * 0'
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/build-emulators.yml'

permissions:
  contents: write
  actions: write

env:
  CACHE_KEY: emu-deps-base
  BUILD_TIMEOUT: 19800  # 5h30 in seconds (leave 30min for cache save)

jobs:
  # ===========================================================================
  # PREPARE: Create and cache base image with all dependencies
  # ===========================================================================
  prepare:
    runs-on: ubuntu-24.04
    outputs:
      azahar_version: ${{ steps.versions.outputs.azahar_version }}
      dolphin_commit: ${{ steps.versions.outputs.dolphin_commit }}
      dolphin_short: ${{ steps.versions.outputs.dolphin_short }}
      duck_commit: ${{ steps.versions.outputs.duck_commit }}
      duck_short: ${{ steps.versions.outputs.duck_short }}
      esde_version: ${{ steps.versions.outputs.esde_version }}
      melonds_version: ${{ steps.versions.outputs.melonds_version }}
      ppsspp_version: ${{ steps.versions.outputs.ppsspp_version }}
      xemu_version: ${{ steps.versions.outputs.xemu_version }}
      citron_version: ${{ steps.versions.outputs.citron_version }}
      build_azahar: ${{ steps.versions.outputs.build_azahar }}
      build_dolphin: ${{ steps.versions.outputs.build_dolphin }}
      build_duckstation: ${{ steps.versions.outputs.build_duckstation }}
      build_esde: ${{ steps.versions.outputs.build_esde }}
      build_melonds: ${{ steps.versions.outputs.build_melonds }}
      build_ppsspp: ${{ steps.versions.outputs.build_ppsspp }}
      build_xemu: ${{ steps.versions.outputs.build_xemu }}
      build_citron: ${{ steps.versions.outputs.build_citron }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Fetch latest versions and check for updates
        id: versions
        run: |
          # Fetch current versions from repo
          CURRENT_AZAHAR=$(cat .azahar-version 2>/dev/null || echo "")
          CURRENT_DOLPHIN=$(cat .dolphin-commit 2>/dev/null || echo "")
          CURRENT_DUCK=$(cat .duckstation-commit 2>/dev/null || echo "")
          CURRENT_ESDE=$(cat .esde-version 2>/dev/null || echo "")
          CURRENT_MELON=$(cat .melonds-version 2>/dev/null || echo "")
          CURRENT_PPSSPP=$(cat .ppsspp-version 2>/dev/null || echo "")
          CURRENT_XEMU=$(cat .xemu-version 2>/dev/null || echo "")
          CURRENT_CITRON=$(cat .citron-version 2>/dev/null || echo "")

          # Fetch latest versions from upstream (with auth to avoid rate limits)
          AUTH_HEADER="Authorization: token ${{ github.token }}"

          AZAHAR_TAG=$(curl -fsSL -H "$AUTH_HEADER" https://api.github.com/repos/azahar-emu/azahar/releases/latest | jq -r '.tag_name // empty')
          DOLPHIN_COMMIT=$(curl -fsSL -H "$AUTH_HEADER" https://api.github.com/repos/dolphin-emu/dolphin/commits/master | jq -r '.sha // empty')
          DUCK_COMMIT=$(curl -fsSL -H "$AUTH_HEADER" https://api.github.com/repos/stenzek/duckstation/commits/master | jq -r '.sha // empty')
          ESDE_TAG=$(curl -fsSL "https://gitlab.com/api/v4/projects/es-de%2Femulationstation-de/releases" | jq -r '.[0].tag_name // empty')
          MELON_TAG=$(curl -fsSL -H "$AUTH_HEADER" https://api.github.com/repos/melonDS-emu/melonDS/releases/latest | jq -r '.tag_name // empty')
          PPSSPP_TAG=$(curl -fsSL -H "$AUTH_HEADER" https://api.github.com/repos/hrydgard/ppsspp/releases/latest | jq -r '.tag_name // empty')
          XEMU_TAG=$(curl -fsSL -H "$AUTH_HEADER" https://api.github.com/repos/xemu-project/xemu/releases/latest | jq -r '.tag_name // empty')
          # Citron: get latest tag via git ls-remote (API blocked from GitHub Actions)
          CITRON_TAG=$(git ls-remote --tags --sort=-v:refname https://git.citron-emu.org/Citron/Emulator.git | head -1 | sed 's/.*refs\/tags\///' | sed 's/\^{}//')

          # Validate versions are not empty
          if [[ -z "$AZAHAR_TAG" || "$AZAHAR_TAG" == "null" ]]; then
            echo "ERROR: Failed to fetch Azahar version"
            exit 1
          fi
          if [[ -z "$MELON_TAG" || "$MELON_TAG" == "null" ]]; then
            echo "ERROR: Failed to fetch melonDS version"
            exit 1
          fi
          if [[ -z "$PPSSPP_TAG" || "$PPSSPP_TAG" == "null" ]]; then
            echo "ERROR: Failed to fetch PPSSPP version"
            exit 1
          fi
          if [[ -z "$XEMU_TAG" || "$XEMU_TAG" == "null" ]]; then
            echo "ERROR: Failed to fetch xemu version"
            exit 1
          fi
          if [[ -z "$CITRON_TAG" ]]; then
            echo "ERROR: Failed to fetch Citron version"
            exit 1
          fi

          # Output versions
          echo "azahar_version=$AZAHAR_TAG" >> $GITHUB_OUTPUT
          echo "dolphin_commit=$DOLPHIN_COMMIT" >> $GITHUB_OUTPUT
          echo "dolphin_short=${DOLPHIN_COMMIT:0:7}" >> $GITHUB_OUTPUT
          echo "duck_commit=$DUCK_COMMIT" >> $GITHUB_OUTPUT
          echo "duck_short=${DUCK_COMMIT:0:7}" >> $GITHUB_OUTPUT
          echo "esde_version=$ESDE_TAG" >> $GITHUB_OUTPUT
          echo "melonds_version=$MELON_TAG" >> $GITHUB_OUTPUT
          echo "ppsspp_version=$PPSSPP_TAG" >> $GITHUB_OUTPUT
          echo "xemu_version=$XEMU_TAG" >> $GITHUB_OUTPUT
          echo "citron_version=$CITRON_TAG" >> $GITHUB_OUTPUT

          # Force rebuild on workflow changes or manual dispatch
          FORCE_REBUILD="${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}"

          # Check if updates are needed (or force rebuild)
          if [[ "$FORCE_REBUILD" == "true" ]] || [[ "$AZAHAR_TAG" != "$CURRENT_AZAHAR" ]]; then
            echo "build_azahar=true" >> $GITHUB_OUTPUT
          else
            echo "build_azahar=false" >> $GITHUB_OUTPUT
          fi

          if [[ "$FORCE_REBUILD" == "true" ]] || [[ "$DOLPHIN_COMMIT" != "$CURRENT_DOLPHIN" ]]; then
            echo "build_dolphin=true" >> $GITHUB_OUTPUT
          else
            echo "build_dolphin=false" >> $GITHUB_OUTPUT
          fi

          if [[ "$FORCE_REBUILD" == "true" ]] || [[ "$DUCK_COMMIT" != "$CURRENT_DUCK" ]]; then
            echo "build_duckstation=true" >> $GITHUB_OUTPUT
          else
            echo "build_duckstation=false" >> $GITHUB_OUTPUT
          fi

          if [[ "$FORCE_REBUILD" == "true" ]] || [[ "$ESDE_TAG" != "$CURRENT_ESDE" ]]; then
            echo "build_esde=true" >> $GITHUB_OUTPUT
          else
            echo "build_esde=false" >> $GITHUB_OUTPUT
          fi

          if [[ "$FORCE_REBUILD" == "true" ]] || [[ "$MELON_TAG" != "$CURRENT_MELON" ]]; then
            echo "build_melonds=true" >> $GITHUB_OUTPUT
          else
            echo "build_melonds=false" >> $GITHUB_OUTPUT
          fi

          if [[ "$FORCE_REBUILD" == "true" ]] || [[ "$PPSSPP_TAG" != "$CURRENT_PPSSPP" ]]; then
            echo "build_ppsspp=true" >> $GITHUB_OUTPUT
          else
            echo "build_ppsspp=false" >> $GITHUB_OUTPUT
          fi

          if [[ "$FORCE_REBUILD" == "true" ]] || [[ "$XEMU_TAG" != "$CURRENT_XEMU" ]]; then
            echo "build_xemu=true" >> $GITHUB_OUTPUT
          else
            echo "build_xemu=false" >> $GITHUB_OUTPUT
          fi

          if [[ "$FORCE_REBUILD" == "true" ]] || [[ "$CITRON_TAG" != "$CURRENT_CITRON" ]]; then
            echo "build_citron=true" >> $GITHUB_OUTPUT
          else
            echo "build_citron=false" >> $GITHUB_OUTPUT
          fi

          echo "Force rebuild: $FORCE_REBUILD"

          # Log status
          echo "=== Build status ==="
          echo "Azahar: $CURRENT_AZAHAR -> $AZAHAR_TAG"
          echo "Dolphin: ${CURRENT_DOLPHIN:0:7} -> ${DOLPHIN_COMMIT:0:7}"
          echo "DuckStation: ${CURRENT_DUCK:0:7} -> ${DUCK_COMMIT:0:7}"
          echo "ES-DE: $CURRENT_ESDE -> $ESDE_TAG"
          echo "melonDS: $CURRENT_MELON -> $MELON_TAG"
          echo "PPSSPP: $CURRENT_PPSSPP -> $PPSSPP_TAG"
          echo "xemu: $CURRENT_XEMU -> $XEMU_TAG"
          echo "Citron: $CURRENT_CITRON -> $CITRON_TAG"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Cache Docker image
        id: cache
        uses: actions/cache@v4
        with:
          path: /tmp/emu-deps.tar
          key: ${{ env.CACHE_KEY }}

      - name: Create base image if not cached
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          docker run --name emu-deps --platform linux/arm64 ubuntu:24.04 bash -c 'echo "base image"'
          docker commit emu-deps emu-deps-image
          docker save emu-deps-image -o /tmp/emu-deps.tar
          docker rm emu-deps

      - name: Load and update base image
        run: |
          docker load -i /tmp/emu-deps.tar
          docker run --name emu-deps-update --platform linux/arm64 \
            emu-deps-image bash -c '
              set -e
              export DEBIAN_FRONTEND=noninteractive

              apt-get update
              apt-get install -y \
                build-essential cmake ninja-build git pkg-config meson dpkg-dev \
                clang llvm lld libc++-dev libc++abi-dev \
                ccache patchelf \
                python3 python3-pip python3-yaml \
                libjemalloc-dev libwayland-dev \
                qt6-base-dev qt6-base-private-dev qt6-multimedia-dev qt6-tools-dev \
                libqt6opengl6-dev libqt6svg6-dev \
                libsdl2-dev libsdl2-ttf-dev \
                libavcodec-dev libavformat-dev libavutil-dev libswscale-dev libavfilter-dev \
                libssl-dev libcurl4-openssl-dev \
                libfmt-dev libzstd-dev libpng-dev liblz4-dev libbz2-dev \
                libpugixml-dev nlohmann-json3-dev \
                libusb-1.0-0-dev libhidapi-dev libevdev-dev \
                libspeexdsp-dev glslang-tools spirv-tools \
                libboost-serialization-dev libboost-context-dev libcubeb-dev libenet-dev \
                libsfml-dev libminiupnpc-dev libmbedtls-dev \
                libsystemd-dev libbluetooth-dev libasound2-dev libpulse-dev \
                liblzo2-dev libxxhash-dev libspng-dev \
                extra-cmake-modules \
                libslirp-dev libarchive-dev \
                libglew-dev libsnappy-dev libzip-dev \
                libfreeimage-dev libfreetype-dev libvlc-dev libpoppler-cpp-dev \
                libepoxy-dev libpixman-1-dev libgtk-3-dev \
                libsamplerate0-dev libpcap-dev libglib2.0-dev \
                libfaad-dev libwebp-dev libsharpyuv-dev libwebpmux3 libwebpdemux2 \
                libpng-dev libjpeg-dev \
                libgit2-dev libharfbuzz-dev \
                gettext \
                libdbus-1-dev libfontconfig1-dev libudev-dev \
                libxcb1-dev libxcb-composite0-dev libxcb-cursor-dev libxcb-damage0-dev \
                libxcb-glx0-dev libxcb-icccm4-dev libxcb-image0-dev libxcb-keysyms1-dev \
                libxcb-present-dev libxcb-randr0-dev libxcb-render0-dev libxcb-render-util0-dev \
                libxcb-shape0-dev libxcb-shm0-dev libxcb-sync-dev libxcb-xfixes0-dev \
                libxcb-xinerama0-dev libxcb-xinput-dev libxcb-xkb-dev \
                libxcb-util-dev libxcb-util0-dev libxcb-ewmh-dev libxcb-dri2-0-dev libxcb-dri3-dev \
                libxkbcommon-dev libxkbcommon-x11-dev libx11-xcb-dev libx11-dev libxext-dev \
                libxrender-dev libxi-dev libxkbfile-dev libxrandr-dev libxcursor-dev \
                libdecor-0-dev libegl-dev libopengl-dev libdrm-dev \
                libpipewire-0.3-dev libinput-dev libgudev-1.0-dev \
                autoconf automake libtool curl wget xz-utils \
                catch2

              apt-get clean
              rm -rf /var/lib/apt/lists/*
            '
          docker commit emu-deps-update emu-deps-image
          docker save emu-deps-image -o /tmp/emu-deps.tar
          docker rm emu-deps-update

  # ===========================================================================
  # BUILD JOBS (with ccache and timeout handling)
  # ===========================================================================

  build-azahar:
    needs: prepare
    if: needs.prepare.outputs.build_azahar == 'true'
    runs-on: ubuntu-24.04
    outputs:
      completed: ${{ steps.build.outputs.completed }}
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Restore cached image
        uses: actions/cache@v4
        with:
          path: /tmp/emu-deps.tar
          key: ${{ env.CACHE_KEY }}

      - name: Load image
        run: docker load -i /tmp/emu-deps.tar

      - name: Restore ccache
        uses: actions/cache/restore@v4
        with:
          path: /tmp/ccache-azahar
          key: ccache-azahar-${{ needs.prepare.outputs.azahar_version }}
          restore-keys: |
            ccache-azahar-

      - name: Build Azahar
        id: build
        run: |
          mkdir -p /tmp/ccache-azahar

          # Start timer
          START_TIME=$(date +%s)

          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -v /tmp/ccache-azahar:/ccache \
            -e VERSION=${{ needs.prepare.outputs.azahar_version }} \
            -e CCACHE_DIR=/ccache \
            -e BUILD_TIMEOUT=${{ env.BUILD_TIMEOUT }} \
            -e START_TIME=$START_TIME \
            emu-deps-image bash -c '
              set -e

              # Setup ccache
              export PATH="/usr/lib/ccache:$PATH"
              export CCACHE_MAXSIZE=5G
              ccache -z

              # Clone source
              if [[ ! -d /workspace/src-azahar ]]; then
                git clone https://github.com/azahar-emu/azahar.git /workspace/src-azahar
              fi

              cd /workspace/src-azahar
              git fetch origin --tags
              git checkout "$VERSION"
              git submodule update --init --recursive

              # Fix X11 None macro conflict - undef the X11 macro before settings.h enums
              # X11 headers define "None" as 0L which breaks C++ enums using None as a value
              { echo "#ifdef None"; echo "#undef None"; echo "#endif"; cat src/common/settings.h; } > src/common/settings.h.tmp
              mv src/common/settings.h.tmp src/common/settings.h

              mkdir -p build && cd build

              # Configure if needed
              if [[ ! -f build.ninja ]]; then
                cmake .. -G Ninja \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DCMAKE_INSTALL_PREFIX=/usr \
                  -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
                  -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                  -DCMAKE_CXX_COMPILER=clang++ \
                  -DCMAKE_C_COMPILER=clang \
                  -DCMAKE_C_FLAGS="-O3 -flto=thin -march=armv8-a+crc+simd -mtune=cortex-a57" \
                  -DCMAKE_CXX_FLAGS="-O3 -flto=thin -march=armv8-a+crc+simd -mtune=cortex-a57" \
                  -DCMAKE_EXE_LINKER_FLAGS="-ljemalloc" \
                  -DCMAKE_SHARED_LINKER_FLAGS="-ljemalloc" \
                  -DENABLE_VULKAN=ON \
                  -DENABLE_OPENGL=ON \
                  -DENABLE_QT_GUI=ON \
                  -DENABLE_SDL2_FRONTEND=OFF \
                  -DENABLE_TESTS=OFF \
                  -DENABLE_WEB_SERVICE=OFF \
                  -DENABLE_X11=ON
              fi

              # Build with timeout check
              timeout ${BUILD_TIMEOUT}s ninja -j$(nproc) || {
                EXIT_CODE=$?
                ccache -s
                if [[ $EXIT_CODE -eq 124 ]]; then
                  echo "TIMEOUT - will retry with cache"
                  echo "timeout" > /workspace/build-status
                  exit 0
                fi
                exit $EXIT_CODE
              }

              # Package
              DESTDIR=/tmp/pkg ninja install
              VERSION_CLEAN=$(echo "$VERSION" | sed "s/^v//")
              mkdir -p /tmp/pkg/DEBIAN
              cat > /tmp/pkg/DEBIAN/control << EOF
          Package: azahar-emu-l4t
          Version: ${VERSION_CLEAN}
          Architecture: arm64
          Maintainer: Ethiquema <noreply@ethiquema.github.io>
          Depends: libc6, libjemalloc2, libqt6widgets6, libqt6gui6, libqt6core6, libqt6multimedia6, libqt6opengl6, libsdl2-2.0-0, libssl3t64, libavcodec60, libavformat60, libswscale7, libspeexdsp1, libfmt9, libzstd1, libusb-1.0-0, libhidapi-hidraw0, libboost-serialization1.83.0, libenet7, liblz4-1
          Provides: citra
          Replaces: citra
          Section: games
          Priority: optional
          Description: Azahar 3DS Emulator (ARM64 L4T build)
          EOF
              dpkg-deb --build /tmp/pkg /workspace/azahar-emu-l4t_${VERSION_CLEAN}_arm64.deb

              ccache -s
              echo "completed" > /workspace/build-status
            '

          # Check result
          if [[ -f build-status ]] && [[ "$(cat build-status)" == "completed" ]]; then
            echo "completed=true" >> $GITHUB_OUTPUT
          else
            echo "completed=false" >> $GITHUB_OUTPUT
          fi

      - name: Save ccache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: /tmp/ccache-azahar
          key: ccache-azahar-${{ needs.prepare.outputs.azahar_version }}-${{ github.run_id }}

      - name: Upload artifact
        if: steps.build.outputs.completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: deb-azahar
          path: "*.deb"
          retention-days: 1

      - name: Trigger retry if timeout
        if: steps.build.outputs.completed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-emulators.yml',
              ref: 'main'
            });
            console.log('Triggered retry workflow');

  build-dolphin:
    needs: prepare
    if: needs.prepare.outputs.build_dolphin == 'true'
    runs-on: ubuntu-24.04
    outputs:
      completed: ${{ steps.build.outputs.completed }}
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Restore cached image
        uses: actions/cache@v4
        with:
          path: /tmp/emu-deps.tar
          key: ${{ env.CACHE_KEY }}

      - name: Load image
        run: docker load -i /tmp/emu-deps.tar

      - name: Restore ccache
        uses: actions/cache/restore@v4
        with:
          path: /tmp/ccache-dolphin
          key: ccache-dolphin-${{ needs.prepare.outputs.dolphin_short }}
          restore-keys: |
            ccache-dolphin-

      - name: Build Dolphin
        id: build
        run: |
          mkdir -p /tmp/ccache-dolphin

          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -v /tmp/ccache-dolphin:/ccache \
            -e COMMIT=${{ needs.prepare.outputs.dolphin_commit }} \
            -e SHORT=${{ needs.prepare.outputs.dolphin_short }} \
            -e CCACHE_DIR=/ccache \
            -e BUILD_TIMEOUT=${{ env.BUILD_TIMEOUT }} \
            emu-deps-image bash -c '
              set -e

              export PATH="/usr/lib/ccache:$PATH"
              export CCACHE_MAXSIZE=5G
              ccache -z

              if [[ ! -d /workspace/src-dolphin ]]; then
                git clone https://github.com/dolphin-emu/dolphin.git /workspace/src-dolphin
              fi

              cd /workspace/src-dolphin
              git fetch origin
              git checkout "$COMMIT"
              git submodule update --init --recursive
              mkdir -p build && cd build

              if [[ ! -f build.ninja ]]; then
                cmake .. -G Ninja \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DCMAKE_INSTALL_PREFIX=/usr \
                  -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
                  -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                  -DCMAKE_C_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57" \
                  -DCMAKE_CXX_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57" \
                  -DCMAKE_EXE_LINKER_FLAGS="-ljemalloc" \
                  -DCMAKE_SHARED_LINKER_FLAGS="-ljemalloc" \
                  -DENABLE_VULKAN=ON \
                  -DENABLE_X11=ON \
                  -DENABLE_WAYLAND=OFF \
                  -DENABLE_TESTS=OFF \
                  -DENABLE_ANALYTICS=OFF
              fi

              timeout ${BUILD_TIMEOUT}s ninja -j$(nproc) || {
                EXIT_CODE=$?
                ccache -s
                if [[ $EXIT_CODE -eq 124 ]]; then
                  echo "timeout" > /workspace/build-status
                  exit 0
                fi
                exit $EXIT_CODE
              }

              DESTDIR=/tmp/pkg ninja install
              PKG_VERSION="0.0.0+git.${SHORT}"
              mkdir -p /tmp/pkg/DEBIAN
              cat > /tmp/pkg/DEBIAN/control << EOF
          Package: dolphin-emu-l4t
          Version: ${PKG_VERSION}
          Architecture: arm64
          Maintainer: Ethiquema <noreply@ethiquema.github.io>
          Depends: libc6, libjemalloc2, libqt6widgets6, libqt6gui6, libqt6core6, libavcodec60, libavformat60, libswscale7, libevdev2, libminiupnpc17, libmbedtls21, libcurl4t64, libhidapi-hidraw0, libsystemd0, libbluetooth3, libasound2t64, libpulse0, libpugixml1v5, libbz2-1.0, libzstd1, liblzo2-2, libpng16-16t64, libusb-1.0-0, libfmt9, libsfml-system2.6, libsfml-network2.6, libxxhash0, libspng0
          Section: games
          Priority: optional
          Description: Dolphin GameCube/Wii Emulator (ARM64 L4T build)
          EOF
              dpkg-deb --build /tmp/pkg /workspace/dolphin-emu-l4t_${PKG_VERSION}_arm64.deb

              ccache -s
              echo "completed" > /workspace/build-status
            '

          if [[ -f build-status ]] && [[ "$(cat build-status)" == "completed" ]]; then
            echo "completed=true" >> $GITHUB_OUTPUT
          else
            echo "completed=false" >> $GITHUB_OUTPUT
          fi

      - name: Save ccache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: /tmp/ccache-dolphin
          key: ccache-dolphin-${{ needs.prepare.outputs.dolphin_short }}-${{ github.run_id }}

      - name: Upload artifact
        if: steps.build.outputs.completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: deb-dolphin
          path: "*.deb"
          retention-days: 1

      - name: Trigger retry if timeout
        if: steps.build.outputs.completed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-emulators.yml',
              ref: 'main'
            });

  build-duckstation:
    needs: prepare
    if: needs.prepare.outputs.build_duckstation == 'true'
    runs-on: ubuntu-24.04
    outputs:
      completed: ${{ steps.build.outputs.completed }}
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Restore cached image
        uses: actions/cache@v4
        with:
          path: /tmp/emu-deps.tar
          key: ${{ env.CACHE_KEY }}

      - name: Load image
        run: docker load -i /tmp/emu-deps.tar

      - name: Restore ccache
        uses: actions/cache/restore@v4
        with:
          path: /tmp/ccache-duck
          key: ccache-duck-${{ needs.prepare.outputs.duck_short }}
          restore-keys: |
            ccache-duck-

      - name: Build DuckStation
        id: build
        run: |
          mkdir -p /tmp/ccache-duck

          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -v /tmp/ccache-duck:/ccache \
            -e COMMIT=${{ needs.prepare.outputs.duck_commit }} \
            -e SHORT=${{ needs.prepare.outputs.duck_short }} \
            -e CCACHE_DIR=/ccache \
            -e BUILD_TIMEOUT=${{ env.BUILD_TIMEOUT }} \
            emu-deps-image bash -c '
              set -e

              export PATH="/usr/lib/ccache:$PATH"
              export CCACHE_MAXSIZE=5G
              ccache -z

              # Clone source
              if [[ ! -d /workspace/src-duck ]]; then
                git clone https://github.com/stenzek/duckstation.git /workspace/src-duck
              fi

              cd /workspace/src-duck
              git fetch origin
              git checkout "$COMMIT"
              git submodule update --init --recursive

              # Use official dependency build script (builds all deps to exact versions)
              if [[ ! -d /workspace/duck-deps ]]; then
                echo "Building dependencies with official script..."
                # Remove -system-harfbuzz to use bundled version (system has incompatible version)
                sed -i "s/-system-harfbuzz//" scripts/deps/build-dependencies-linux.sh
                scripts/deps/build-dependencies-linux.sh /workspace/duck-deps
              fi

              mkdir -p build && cd build

              if [[ ! -f build.ninja ]]; then
                cmake .. -G Ninja \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DCMAKE_INSTALL_PREFIX=/usr \
                  -DCMAKE_PREFIX_PATH=/workspace/duck-deps \
                  -DCMAKE_C_COMPILER=clang \
                  -DCMAKE_CXX_COMPILER=clang++ \
                  -DCMAKE_EXE_LINKER_FLAGS_INIT="-fuse-ld=lld -ljemalloc" \
                  -DCMAKE_MODULE_LINKER_FLAGS_INIT="-fuse-ld=lld" \
                  -DCMAKE_SHARED_LINKER_FLAGS_INIT="-fuse-ld=lld -ljemalloc" \
                  -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
                  -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                  -DCMAKE_C_FLAGS="-O3 -flto=thin -march=armv8-a+crc+simd -mtune=cortex-a57" \
                  -DCMAKE_CXX_FLAGS="-O3 -flto=thin -march=armv8-a+crc+simd -mtune=cortex-a57" \
                  -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON \
                  -DENABLE_WAYLAND=OFF \
                  -DENABLE_X11=ON
              fi

              timeout ${BUILD_TIMEOUT}s ninja -j$(nproc) || {
                EXIT_CODE=$?
                ccache -s
                if [[ $EXIT_CODE -eq 124 ]]; then
                  echo "timeout" > /workspace/build-status
                  exit 0
                fi
                exit $EXIT_CODE
              }

              DESTDIR=/tmp/pkg ninja install

              # Bundle the custom-built libraries
              mkdir -p /tmp/pkg/usr/lib/duckstation
              cp /workspace/duck-deps/lib/*.so* /tmp/pkg/usr/lib/duckstation/ 2>/dev/null || true

              # Set rpath for bundled libs
              patchelf --set-rpath /usr/lib/duckstation /tmp/pkg/usr/bin/duckstation-qt 2>/dev/null || true

              PKG_VERSION="0.0.0+git.${SHORT}"
              mkdir -p /tmp/pkg/DEBIAN
              cat > /tmp/pkg/DEBIAN/control << EOF
          Package: duckstation-l4t
          Version: ${PKG_VERSION}
          Architecture: arm64
          Maintainer: Ethiquema <noreply@ethiquema.github.io>
          Depends: libc6, libjemalloc2, libdbus-1-3, libcurl4t64, libwayland-client0, libudev1
          Section: games
          Priority: optional
          Description: DuckStation PS1 Emulator (ARM64 L4T build)
           Includes bundled Qt6, SDL3 and other libraries.
          EOF
              dpkg-deb --build /tmp/pkg /workspace/duckstation-l4t_${PKG_VERSION}_arm64.deb

              ccache -s
              echo "completed" > /workspace/build-status
            '

          if [[ -f build-status ]] && [[ "$(cat build-status)" == "completed" ]]; then
            echo "completed=true" >> $GITHUB_OUTPUT
          else
            echo "completed=false" >> $GITHUB_OUTPUT
          fi

      - name: Save ccache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: /tmp/ccache-duck
          key: ccache-duck-${{ needs.prepare.outputs.duck_short }}-${{ github.run_id }}

      - name: Upload artifact
        if: steps.build.outputs.completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: deb-duckstation
          path: "*.deb"
          retention-days: 1

      - name: Trigger retry if timeout
        if: steps.build.outputs.completed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-emulators.yml',
              ref: 'main'
            });

  build-esde:
    needs: prepare
    if: needs.prepare.outputs.build_esde == 'true'
    runs-on: ubuntu-24.04
    outputs:
      completed: ${{ steps.build.outputs.completed }}
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Restore cached image
        uses: actions/cache@v4
        with:
          path: /tmp/emu-deps.tar
          key: ${{ env.CACHE_KEY }}

      - name: Load image
        run: docker load -i /tmp/emu-deps.tar

      - name: Restore ccache
        uses: actions/cache/restore@v4
        with:
          path: /tmp/ccache-esde
          key: ccache-esde-${{ needs.prepare.outputs.esde_version }}
          restore-keys: |
            ccache-esde-

      - name: Build EmulationStation-DE
        id: build
        run: |
          mkdir -p /tmp/ccache-esde

          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -v /tmp/ccache-esde:/ccache \
            -e VERSION=${{ needs.prepare.outputs.esde_version }} \
            -e CCACHE_DIR=/ccache \
            -e BUILD_TIMEOUT=${{ env.BUILD_TIMEOUT }} \
            emu-deps-image bash -c '
              set -e

              export PATH="/usr/lib/ccache:$PATH"
              export CCACHE_MAXSIZE=5G
              ccache -z

              if [[ ! -d /workspace/src-esde ]]; then
                git clone https://gitlab.com/es-de/emulationstation-de.git /workspace/src-esde
              fi

              cd /workspace/src-esde
              git fetch origin --tags
              git checkout "$VERSION"
              mkdir -p build && cd build

              if [[ ! -f build.ninja ]]; then
                cmake .. -G Ninja \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DCMAKE_INSTALL_PREFIX=/usr \
                  -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
                  -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                  -DCMAKE_C_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57" \
                  -DCMAKE_CXX_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57"
              fi

              timeout ${BUILD_TIMEOUT}s ninja -j$(nproc) || {
                EXIT_CODE=$?
                ccache -s
                if [[ $EXIT_CODE -eq 124 ]]; then
                  echo "timeout" > /workspace/build-status
                  exit 0
                fi
                exit $EXIT_CODE
              }

              DESTDIR=/tmp/pkg ninja install
              VERSION_CLEAN=$(echo "$VERSION" | sed "s/^v//")
              mkdir -p /tmp/pkg/DEBIAN
              cat > /tmp/pkg/DEBIAN/control << EOF
          Package: emulationstation-de-l4t
          Version: ${VERSION_CLEAN}
          Architecture: arm64
          Maintainer: Ethiquema <noreply@ethiquema.github.io>
          Depends: libc6, libsdl2-2.0-0, libavcodec60, libavformat60, libswscale7, libfreeimage3t64, libfreetype6, libcurl4t64, libpugixml1v5, libvlc5, libpoppler-cpp0t64
          Provides: emulationstation
          Conflicts: emulationstation
          Section: games
          Priority: optional
          Description: EmulationStation Desktop Edition (ARM64 L4T build)
          EOF
              dpkg-deb --build /tmp/pkg /workspace/emulationstation-de-l4t_${VERSION_CLEAN}_arm64.deb

              ccache -s
              echo "completed" > /workspace/build-status
            '

          if [[ -f build-status ]] && [[ "$(cat build-status)" == "completed" ]]; then
            echo "completed=true" >> $GITHUB_OUTPUT
          else
            echo "completed=false" >> $GITHUB_OUTPUT
          fi

      - name: Save ccache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: /tmp/ccache-esde
          key: ccache-esde-${{ needs.prepare.outputs.esde_version }}-${{ github.run_id }}

      - name: Upload artifact
        if: steps.build.outputs.completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: deb-esde
          path: "*.deb"
          retention-days: 1

      - name: Trigger retry if timeout
        if: steps.build.outputs.completed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-emulators.yml',
              ref: 'main'
            });

  build-melonds:
    needs: prepare
    if: needs.prepare.outputs.build_melonds == 'true'
    runs-on: ubuntu-24.04
    outputs:
      completed: ${{ steps.build.outputs.completed }}
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Restore cached image
        uses: actions/cache@v4
        with:
          path: /tmp/emu-deps.tar
          key: ${{ env.CACHE_KEY }}

      - name: Load image
        run: docker load -i /tmp/emu-deps.tar

      - name: Restore ccache
        uses: actions/cache/restore@v4
        with:
          path: /tmp/ccache-melonds
          key: ccache-melonds-${{ needs.prepare.outputs.melonds_version }}
          restore-keys: |
            ccache-melonds-

      - name: Build melonDS
        id: build
        run: |
          mkdir -p /tmp/ccache-melonds

          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -v /tmp/ccache-melonds:/ccache \
            -e VERSION=${{ needs.prepare.outputs.melonds_version }} \
            -e CCACHE_DIR=/ccache \
            -e BUILD_TIMEOUT=${{ env.BUILD_TIMEOUT }} \
            emu-deps-image bash -c '
              set -e

              export PATH="/usr/lib/ccache:$PATH"
              export CCACHE_MAXSIZE=5G
              ccache -z

              if [[ ! -d /workspace/src-melonds ]]; then
                git clone https://github.com/melonDS-emu/melonDS.git /workspace/src-melonds
              fi

              cd /workspace/src-melonds
              git fetch origin --tags
              git checkout "$VERSION"
              mkdir -p build && cd build

              if [[ ! -f build.ninja ]]; then
                cmake .. -G Ninja \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DCMAKE_INSTALL_PREFIX=/usr \
                  -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
                  -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                  -DCMAKE_C_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57" \
                  -DCMAKE_CXX_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57" \
                  -DCMAKE_EXE_LINKER_FLAGS="-ljemalloc" \
                  -DCMAKE_SHARED_LINKER_FLAGS="-ljemalloc"
              fi

              timeout ${BUILD_TIMEOUT}s ninja -j$(nproc) || {
                EXIT_CODE=$?
                ccache -s
                if [[ $EXIT_CODE -eq 124 ]]; then
                  echo "timeout" > /workspace/build-status
                  exit 0
                fi
                exit $EXIT_CODE
              }

              DESTDIR=/tmp/pkg ninja install
              VERSION_CLEAN=$(echo "$VERSION" | sed "s/^v//")
              mkdir -p /tmp/pkg/DEBIAN
              cat > /tmp/pkg/DEBIAN/control << EOF
          Package: melonds-l4t
          Version: ${VERSION_CLEAN}
          Architecture: arm64
          Maintainer: Ethiquema <noreply@ethiquema.github.io>
          Depends: libc6, libjemalloc2, libqt6widgets6, libqt6gui6, libqt6core6, libqt6multimedia6, libsdl2-2.0-0, libslirp0, libarchive13t64, libzstd1
          Section: games
          Priority: optional
          Description: melonDS Nintendo DS Emulator (ARM64 L4T build)
          EOF
              dpkg-deb --build /tmp/pkg /workspace/melonds-l4t_${VERSION_CLEAN}_arm64.deb

              ccache -s
              echo "completed" > /workspace/build-status
            '

          if [[ -f build-status ]] && [[ "$(cat build-status)" == "completed" ]]; then
            echo "completed=true" >> $GITHUB_OUTPUT
          else
            echo "completed=false" >> $GITHUB_OUTPUT
          fi

      - name: Save ccache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: /tmp/ccache-melonds
          key: ccache-melonds-${{ needs.prepare.outputs.melonds_version }}-${{ github.run_id }}

      - name: Upload artifact
        if: steps.build.outputs.completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: deb-melonds
          path: "*.deb"
          retention-days: 1

      - name: Trigger retry if timeout
        if: steps.build.outputs.completed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-emulators.yml',
              ref: 'main'
            });

  build-ppsspp:
    needs: prepare
    if: needs.prepare.outputs.build_ppsspp == 'true'
    runs-on: ubuntu-24.04
    outputs:
      completed: ${{ steps.build.outputs.completed }}
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Restore cached image
        uses: actions/cache@v4
        with:
          path: /tmp/emu-deps.tar
          key: ${{ env.CACHE_KEY }}

      - name: Load image
        run: docker load -i /tmp/emu-deps.tar

      - name: Restore ccache
        uses: actions/cache/restore@v4
        with:
          path: /tmp/ccache-ppsspp
          key: ccache-ppsspp-${{ needs.prepare.outputs.ppsspp_version }}
          restore-keys: |
            ccache-ppsspp-

      - name: Build PPSSPP
        id: build
        run: |
          mkdir -p /tmp/ccache-ppsspp

          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -v /tmp/ccache-ppsspp:/ccache \
            -e VERSION=${{ needs.prepare.outputs.ppsspp_version }} \
            -e CCACHE_DIR=/ccache \
            -e BUILD_TIMEOUT=${{ env.BUILD_TIMEOUT }} \
            emu-deps-image bash -c '
              set -e

              export PATH="/usr/lib/ccache:$PATH"
              export CCACHE_MAXSIZE=5G
              ccache -z

              if [[ ! -d /workspace/src-ppsspp ]]; then
                git clone https://github.com/hrydgard/ppsspp.git /workspace/src-ppsspp
              fi

              cd /workspace/src-ppsspp
              git fetch origin --tags
              git checkout "$VERSION"
              git submodule update --init --recursive
              mkdir -p build && cd build

              if [[ ! -f build.ninja ]]; then
                cmake .. -G Ninja \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DCMAKE_INSTALL_PREFIX=/usr \
                  -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
                  -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                  -DCMAKE_C_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57" \
                  -DCMAKE_CXX_FLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57" \
                  -DCMAKE_EXE_LINKER_FLAGS="-ljemalloc" \
                  -DCMAKE_SHARED_LINKER_FLAGS="-ljemalloc" \
                  -DUSING_QT_UI=OFF \
                  -DHEADLESS=OFF \
                  -DUSE_WAYLAND_WSI=OFF \
                  -DVULKAN=ON
              fi

              timeout ${BUILD_TIMEOUT}s ninja -j$(nproc) || {
                EXIT_CODE=$?
                ccache -s
                if [[ $EXIT_CODE -eq 124 ]]; then
                  echo "timeout" > /workspace/build-status
                  exit 0
                fi
                exit $EXIT_CODE
              }

              mkdir -p /tmp/pkg/usr/bin /tmp/pkg/usr/share/applications /tmp/pkg/usr/share/ppsspp
              cp PPSSPPSDL /tmp/pkg/usr/bin/ppsspp
              cp -r ../assets /tmp/pkg/usr/share/ppsspp/

              cat > /tmp/pkg/usr/share/applications/ppsspp.desktop << DESK
          [Desktop Entry]
          Name=PPSSPP
          Comment=PlayStation Portable Emulator
          Exec=ppsspp
          Icon=ppsspp
          Terminal=false
          Type=Application
          Categories=Game;Emulator;
          DESK

              VERSION_CLEAN=$(echo "$VERSION" | sed "s/^v//")
              mkdir -p /tmp/pkg/DEBIAN
              cat > /tmp/pkg/DEBIAN/control << EOF
          Package: ppsspp-l4t
          Version: ${VERSION_CLEAN}
          Architecture: arm64
          Maintainer: Ethiquema <noreply@ethiquema.github.io>
          Depends: libc6, libjemalloc2, libsdl2-2.0-0, libsdl2-ttf-2.0-0, libglew2.2, libsnappy1v5, libavcodec60, libavformat60, libswscale7, libzip4t64, libpng16-16t64
          Provides: ppsspp
          Conflicts: ppsspp
          Section: games
          Priority: optional
          Description: PPSSPP PlayStation Portable Emulator (ARM64 L4T build)
          EOF
              dpkg-deb --build /tmp/pkg /workspace/ppsspp-l4t_${VERSION_CLEAN}_arm64.deb

              ccache -s
              echo "completed" > /workspace/build-status
            '

          if [[ -f build-status ]] && [[ "$(cat build-status)" == "completed" ]]; then
            echo "completed=true" >> $GITHUB_OUTPUT
          else
            echo "completed=false" >> $GITHUB_OUTPUT
          fi

      - name: Save ccache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: /tmp/ccache-ppsspp
          key: ccache-ppsspp-${{ needs.prepare.outputs.ppsspp_version }}-${{ github.run_id }}

      - name: Upload artifact
        if: steps.build.outputs.completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: deb-ppsspp
          path: "*.deb"
          retention-days: 1

      - name: Trigger retry if timeout
        if: steps.build.outputs.completed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-emulators.yml',
              ref: 'main'
            });

  build-xemu:
    needs: prepare
    if: needs.prepare.outputs.build_xemu == 'true'
    runs-on: ubuntu-24.04
    outputs:
      completed: ${{ steps.build.outputs.completed }}
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Restore cached image
        uses: actions/cache@v4
        with:
          path: /tmp/emu-deps.tar
          key: ${{ env.CACHE_KEY }}

      - name: Load image
        run: docker load -i /tmp/emu-deps.tar

      - name: Restore ccache
        uses: actions/cache/restore@v4
        with:
          path: /tmp/ccache-xemu
          key: ccache-xemu-${{ needs.prepare.outputs.xemu_version }}
          restore-keys: |
            ccache-xemu-

      - name: Build xemu
        id: build
        run: |
          mkdir -p /tmp/ccache-xemu

          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -v /tmp/ccache-xemu:/ccache \
            -e VERSION=${{ needs.prepare.outputs.xemu_version }} \
            -e CCACHE_DIR=/ccache \
            -e BUILD_TIMEOUT=${{ env.BUILD_TIMEOUT }} \
            emu-deps-image bash -c '
              set -e

              export PATH="/usr/lib/ccache:$PATH"
              export CCACHE_MAXSIZE=5G
              ccache -z

              if [[ ! -d /workspace/src-xemu ]]; then
                git clone https://github.com/xemu-project/xemu.git /workspace/src-xemu
              fi

              cd /workspace/src-xemu
              git fetch origin --tags
              git checkout "$VERSION"
              git submodule update --init --recursive

              export CFLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57"
              export CXXFLAGS="-O3 -flto -march=armv8-a+crc+simd -mtune=cortex-a57"
              export LDFLAGS="-ljemalloc"

              # Build with X11 (XWayland)
              timeout ${BUILD_TIMEOUT}s ./build.sh --enable-sdl --disable-werror || {
                EXIT_CODE=$?
                ccache -s
                if [[ $EXIT_CODE -eq 124 ]]; then
                  echo "timeout" > /workspace/build-status
                  exit 0
                fi
                exit $EXIT_CODE
              }

              mkdir -p /tmp/pkg/usr/bin /tmp/pkg/usr/share/applications
              cp dist/xemu /tmp/pkg/usr/bin/

              cat > /tmp/pkg/usr/share/applications/xemu.desktop << DESK
          [Desktop Entry]
          Name=xemu
          Comment=Original Xbox Emulator
          Exec=xemu
          Icon=xemu
          Terminal=false
          Type=Application
          Categories=Game;Emulator;
          DESK

              VERSION_CLEAN=$(echo "$VERSION" | sed "s/^v//")
              mkdir -p /tmp/pkg/DEBIAN
              cat > /tmp/pkg/DEBIAN/control << EOF
          Package: xemu-l4t
          Version: ${VERSION_CLEAN}
          Architecture: arm64
          Maintainer: Ethiquema <noreply@ethiquema.github.io>
          Depends: libc6, libjemalloc2, libsdl2-2.0-0, libepoxy0, libpixman-1-0, libgtk-3-0t64, libssl3t64, libsamplerate0, libpcap0.8t64, libslirp0
          Section: games
          Priority: optional
          Description: xemu Original Xbox Emulator (ARM64 L4T build)
          EOF
              dpkg-deb --build /tmp/pkg /workspace/xemu-l4t_${VERSION_CLEAN}_arm64.deb

              ccache -s
              echo "completed" > /workspace/build-status
            '

          if [[ -f build-status ]] && [[ "$(cat build-status)" == "completed" ]]; then
            echo "completed=true" >> $GITHUB_OUTPUT
          else
            echo "completed=false" >> $GITHUB_OUTPUT
          fi

      - name: Save ccache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: /tmp/ccache-xemu
          key: ccache-xemu-${{ needs.prepare.outputs.xemu_version }}-${{ github.run_id }}

      - name: Upload artifact
        if: steps.build.outputs.completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: deb-xemu
          path: "*.deb"
          retention-days: 1

      - name: Trigger retry if timeout
        if: steps.build.outputs.completed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-emulators.yml',
              ref: 'main'
            });

  build-citron:
    needs: prepare
    if: needs.prepare.outputs.build_citron == 'true'
    runs-on: ubuntu-24.04
    outputs:
      completed: ${{ steps.build.outputs.completed }}
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Restore cached image
        uses: actions/cache@v4
        with:
          path: /tmp/emu-deps.tar
          key: ${{ env.CACHE_KEY }}

      - name: Load image
        run: docker load -i /tmp/emu-deps.tar

      - name: Restore ccache
        uses: actions/cache/restore@v4
        with:
          path: /tmp/ccache-citron
          key: ccache-citron-${{ needs.prepare.outputs.citron_version }}
          restore-keys: |
            ccache-citron-

      - name: Build Citron
        id: build
        run: |
          mkdir -p /tmp/ccache-citron

          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -v /tmp/ccache-citron:/ccache \
            -e VERSION=${{ needs.prepare.outputs.citron_version }} \
            -e CCACHE_DIR=/ccache \
            -e BUILD_TIMEOUT=${{ env.BUILD_TIMEOUT }} \
            emu-deps-image bash -c '
              set -e

              export PATH="/usr/lib/ccache:$PATH"
              export CCACHE_MAXSIZE=5G
              ccache -z

              # Clone source from Citron Forgejo
              if [[ ! -d /workspace/src-citron ]]; then
                git clone https://git.citron-emu.org/Citron/Emulator.git /workspace/src-citron
              fi

              cd /workspace/src-citron
              git fetch origin --tags
              git checkout "$VERSION"
              git submodule update --init --recursive

              mkdir -p build && cd build

              if [[ ! -f build.ninja ]]; then
                cmake .. -G Ninja \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DCMAKE_INSTALL_PREFIX=/usr \
                  -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
                  -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                  -DCMAKE_CXX_COMPILER=clang++ \
                  -DCMAKE_C_COMPILER=clang \
                  -DCMAKE_C_FLAGS="-O3 -flto=thin -march=armv8-a+crc+simd -mtune=cortex-a57" \
                  -DCMAKE_CXX_FLAGS="-O3 -flto=thin -march=armv8-a+crc+simd -mtune=cortex-a57" \
                  -DCMAKE_EXE_LINKER_FLAGS="-ljemalloc" \
                  -DCMAKE_SHARED_LINKER_FLAGS="-ljemalloc" \
                  -DYUZU_USE_BUNDLED_VCPKG=OFF \
                  -DYUZU_TESTS=OFF \
                  -DENABLE_QT_TRANSLATION=OFF \
                  -DSPIRV_WERROR=OFF
              fi

              timeout ${BUILD_TIMEOUT}s ninja -j$(nproc) || {
                EXIT_CODE=$?
                ccache -s
                if [[ $EXIT_CODE -eq 124 ]]; then
                  echo "timeout" > /workspace/build-status
                  exit 0
                fi
                exit $EXIT_CODE
              }

              DESTDIR=/tmp/pkg ninja install
              VERSION_CLEAN=$(echo "$VERSION" | sed "s/^v//")
              mkdir -p /tmp/pkg/DEBIAN
              cat > /tmp/pkg/DEBIAN/control << EOF
          Package: citron-emu-l4t
          Version: ${VERSION_CLEAN}
          Architecture: arm64
          Maintainer: Ethiquema <noreply@ethiquema.github.io>
          Depends: libc6, libjemalloc2, libqt6widgets6, libqt6gui6, libqt6core6, libqt6multimedia6, libqt6opengl6, libsdl2-2.0-0, libssl3t64, libavcodec60, libavformat60, libswscale7, libopus0, libzstd1, libusb-1.0-0, libva2, liblz4-1
          Section: games
          Priority: optional
          Description: Citron Nintendo Switch Emulator (ARM64 L4T build)
          EOF
              dpkg-deb --build /tmp/pkg /workspace/citron-emu-l4t_${VERSION_CLEAN}_arm64.deb

              ccache -s
              echo "completed" > /workspace/build-status
            '

          if [[ -f build-status ]] && [[ "$(cat build-status)" == "completed" ]]; then
            echo "completed=true" >> $GITHUB_OUTPUT
          else
            echo "completed=false" >> $GITHUB_OUTPUT
          fi

      - name: Save ccache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: /tmp/ccache-citron
          key: ccache-citron-${{ needs.prepare.outputs.citron_version }}-${{ github.run_id }}

      - name: Upload artifact
        if: steps.build.outputs.completed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: deb-citron
          path: "*.deb"
          retention-days: 1

      - name: Trigger retry if timeout
        if: steps.build.outputs.completed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-emulators.yml',
              ref: 'main'
            });

  build-setperf:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Build setperf package
        run: |
          cd packages/setperf
          chmod +x build.sh
          ./build.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-setperf
          path: "packages/setperf/*.deb"
          retention-days: 1

  # ===========================================================================
  # UPDATE REPO: Collect all debs and update APT repository
  # ===========================================================================
  update-repo:
    needs: [prepare, build-azahar, build-dolphin, build-duckstation, build-esde, build-melonds, build-ppsspp, build-xemu, build-citron, build-setperf]
    if: always()
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: deb-*
          merge-multiple: true

      - name: Check for packages
        id: check
        run: |
          if ls *.deb 1> /dev/null 2>&1; then
            echo "has_debs=true" >> $GITHUB_OUTPUT
            ls -la *.deb
          else
            echo "has_debs=false" >> $GITHUB_OUTPUT
            echo "No packages to publish"
          fi

      - name: Checkout gh-pages
        if: steps.check.outputs.has_debs == 'true'
        run: |
          git fetch origin gh-pages:gh-pages || true
          git worktree add gh-pages-dir gh-pages || {
            git worktree add --detach gh-pages-dir
            cd gh-pages-dir
            git checkout --orphan gh-pages
            git rm -rf . 2>/dev/null || true
            mkdir -p pool/main dists/noble/main/binary-arm64
            cd ..
          }

      - name: Install APT tools
        if: steps.check.outputs.has_debs == 'true'
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev apt-utils

      - name: Import GPG key
        if: steps.check.outputs.has_debs == 'true'
        run: |
          echo "${{ secrets.PRIVATE }}" | gpg --batch --import
          gpg --armor --export "Ethiquema L4T Repo" > gh-pages-dir/public.key

      - name: Add packages to pool
        if: steps.check.outputs.has_debs == 'true'
        run: |
          mkdir -p gh-pages-dir/pool/main
          cp *.deb gh-pages-dir/pool/main/

      - name: Regenerate APT repository metadata
        if: steps.check.outputs.has_debs == 'true'
        run: |
          cd gh-pages-dir
          mkdir -p dists/noble/main/binary-arm64

          dpkg-scanpackages --arch arm64 pool/ > dists/noble/main/binary-arm64/Packages
          gzip -k -f dists/noble/main/binary-arm64/Packages

          cd dists/noble
          cat > Release << EOF
          Origin: Ethiquema L4T Repository
          Label: l4t-debs
          Suite: noble
          Codename: noble
          Architectures: arm64
          Components: main
          Description: L4T packages for Nintendo Switch
          EOF

          apt-ftparchive release . >> Release
          rm -f Release.gpg InRelease
          gpg --batch --default-key "Ethiquema L4T Repo" -abs -o Release.gpg Release
          gpg --batch --default-key "Ethiquema L4T Repo" --clearsign -o InRelease Release

      - name: Deploy to gh-pages
        if: steps.check.outputs.has_debs == 'true'
        run: |
          cd gh-pages-dir
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Update APT repository" || echo "No changes"
          git push origin gh-pages

      - name: Save version trackers
        if: steps.check.outputs.has_debs == 'true'
        run: |
          echo "${{ needs.prepare.outputs.azahar_version }}" > .azahar-version
          echo "${{ needs.prepare.outputs.dolphin_commit }}" > .dolphin-commit
          echo "${{ needs.prepare.outputs.duck_commit }}" > .duckstation-commit
          echo "${{ needs.prepare.outputs.esde_version }}" > .esde-version
          echo "${{ needs.prepare.outputs.melonds_version }}" > .melonds-version
          echo "${{ needs.prepare.outputs.ppsspp_version }}" > .ppsspp-version
          echo "${{ needs.prepare.outputs.xemu_version }}" > .xemu-version

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .*-version .*-commit 2>/dev/null || true
          git commit -m "Update version trackers" || echo "No changes"
          git push origin main
