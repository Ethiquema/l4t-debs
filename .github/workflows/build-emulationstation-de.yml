name: Build EmulationStation-DE ARM64 .deb

on:
  schedule:
    - cron: '0 4 * * 0'
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/build-emulationstation-de.yml'

permissions:
  contents: write

concurrency:
  group: apt-repo-update
  cancel-in-progress: false

jobs:
  build-esde:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Check for new ES-DE release
        id: check
        run: |
          # Force rebuild if workflow file was modified
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "Workflow modified, forcing rebuild"
            FORCE_BUILD=true
          else
            FORCE_BUILD=false
          fi

          # ES-DE uses GitLab, check the API for aarch64 package
          RELEASES=$(curl -fsSL "https://gitlab.com/api/v4/projects/es-de%2Femulationstation-de/releases")
          LATEST_TAG=$(echo "$RELEASES" | jq -r '.[0].tag_name')
          echo "Latest ES-DE release: $LATEST_TAG"

          STORED_VERSION=""
          if [ -f .esde-version ]; then
            STORED_VERSION=$(cat .esde-version)
          fi

          if [ "$LATEST_TAG" != "$STORED_VERSION" ] || [ "$FORCE_BUILD" = "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT

            # Get aarch64 AppImage URL from prerelease section on es-de.org
            # The aarch64 build is experimental and updated separately
            APPIMAGE_URL="https://gitlab.com/es-de/emulationstation-de/-/package_files/248914983/download"
            echo "appimage_url=$APPIMAGE_URL" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Download and repackage as .deb
        if: steps.check.outputs.should_build == 'true'
        run: |
          set -e
          VERSION="${{ steps.check.outputs.version }}"
          # Remove 'v' prefix for dpkg compatibility
          VERSION_CLEAN=$(echo "$VERSION" | sed 's/^v//')

          # Download AppImage
          curl -fsSL -o esde.AppImage "${{ steps.check.outputs.appimage_url }}"
          chmod +x esde.AppImage

          # Create .deb structure
          mkdir -p esde-pkg/DEBIAN
          mkdir -p esde-pkg/usr/bin
          mkdir -p esde-pkg/usr/share/applications

          cp esde.AppImage esde-pkg/usr/bin/EmulationStation-DE.AppImage

          cat > esde-pkg/usr/bin/emulationstation << 'WRAPPER'
          #!/bin/bash
          exec /usr/bin/EmulationStation-DE.AppImage --no-splash "$@"
          WRAPPER
          chmod +x esde-pkg/usr/bin/emulationstation

          cat > esde-pkg/usr/share/applications/emulationstation-de.desktop << 'DESKTOP'
          [Desktop Entry]
          Name=EmulationStation Desktop Edition
          Comment=Emulator Frontend
          Exec=emulationstation
          Icon=emulationstation
          Terminal=false
          Type=Application
          Categories=Game;Emulator;
          DESKTOP

          cat > esde-pkg/DEBIAN/control << EOF
          Package: emulationstation-de-l4t
          Version: ${VERSION_CLEAN}
          Architecture: arm64
          Maintainer: Ethiquema <noreply@ethiquema.github.io>
          Depends: libfuse2t64 | libfuse2
          Provides: emulationstation
          Conflicts: emulationstation
          Section: games
          Priority: optional
          Description: EmulationStation Desktop Edition (ARM64 AppImage)
           Frontend for browsing and launching emulators and games.
           Optimized for Nintendo Switch L4T.
          EOF

          dpkg-deb --build esde-pkg emulationstation-de-l4t_${VERSION_CLEAN}_arm64.deb

      - name: Save version tracker
        if: steps.check.outputs.should_build == 'true'
        run: echo "${{ steps.check.outputs.version }}" > .esde-version

      - name: Checkout gh-pages
        if: steps.check.outputs.should_build == 'true'
        run: |
          git fetch origin gh-pages:gh-pages || true
          git worktree add gh-pages-dir gh-pages || {
            git worktree add --detach gh-pages-dir
            cd gh-pages-dir
            git checkout --orphan gh-pages
            git rm -rf . 2>/dev/null || true
            mkdir -p pool/main dists/noble/main/binary-arm64
            cd ..
          }

      - name: Install APT tools
        if: steps.check.outputs.should_build == 'true'
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev apt-utils

      - name: Import GPG key and add package
        if: steps.check.outputs.should_build == 'true'
        run: |
          echo "${{ secrets.PRIVATE }}" | gpg --batch --import
          gpg --armor --export "Ethiquema L4T Repo" > gh-pages-dir/public.key
          mkdir -p gh-pages-dir/pool/main
          cp emulationstation-de-l4t_*_arm64.deb gh-pages-dir/pool/main/

      - name: Regenerate APT repository metadata
        if: steps.check.outputs.should_build == 'true'
        run: |
          cd gh-pages-dir
          mkdir -p dists/noble/main/binary-arm64
          dpkg-scanpackages --arch arm64 pool/ > dists/noble/main/binary-arm64/Packages
          gzip -k -f dists/noble/main/binary-arm64/Packages
          cd dists/noble
          cat > Release << EOF
          Origin: Ethiquema L4T Repository
          Label: l4t-debs
          Suite: noble
          Codename: noble
          Architectures: arm64
          Components: main
          Description: L4T packages for Nintendo Switch
          EOF
          apt-ftparchive release . >> Release
          rm -f Release.gpg InRelease
          gpg --batch --default-key "Ethiquema L4T Repo" -abs -o Release.gpg Release
          gpg --batch --default-key "Ethiquema L4T Repo" --clearsign -o InRelease Release

      - name: Deploy to gh-pages
        if: steps.check.outputs.should_build == 'true'
        run: |
          cd gh-pages-dir
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Add EmulationStation-DE ${{ steps.check.outputs.version }} ARM64" || echo "No changes"
          git push origin gh-pages

      - name: Save tracker to main
        if: steps.check.outputs.should_build == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .esde-version
          git commit -m "Update EmulationStation-DE version tracker" || echo "No changes"
          git push origin main
