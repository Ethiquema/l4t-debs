name: Build Dolphin ARM64 .deb

on:
  schedule:
    # Run weekly on Sunday at 4am UTC
    - cron: '0 4 * * 0'
  workflow_dispatch:
    # Allow manual trigger
  push:
    paths:
      - '.github/workflows/build-dolphin.yml'

permissions:
  contents: write

jobs:
  build-dolphin:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Check for new Dolphin commits
        id: check
        run: |
          # Force rebuild if workflow file was modified
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "Workflow modified, forcing rebuild"
            FORCE_BUILD=true
          else
            FORCE_BUILD=false
          fi

          # Dolphin doesn't use GitHub releases, check latest commit on master
          LATEST_COMMIT=$(curl -fsSL https://api.github.com/repos/dolphin-emu/dolphin/commits/master | jq -r '.sha')
          SHORT_SHA=${LATEST_COMMIT:0:7}
          echo "Latest Dolphin commit: $SHORT_SHA"

          # Get stored commit
          STORED_COMMIT=""
          if [ -f .dolphin-commit ]; then
            STORED_COMMIT=$(cat .dolphin-commit)
          fi
          echo "Stored commit: ${STORED_COMMIT:0:7}"

          if [ "$LATEST_COMMIT" != "$STORED_COMMIT" ] || [ "$FORCE_BUILD" = "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
            echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
            echo "Build triggered"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "No new commits"
          fi

      - name: Set up QEMU for ARM64
        if: steps.check.outputs.should_build == 'true'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build Dolphin in ARM64 container
        if: steps.check.outputs.should_build == 'true'
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -e COMMIT=${{ steps.check.outputs.commit }} \
            -e SHORT_SHA=${{ steps.check.outputs.short_sha }} \
            ubuntu:24.04 bash -c '
              set -e
              export DEBIAN_FRONTEND=noninteractive

              echo "=== Installing build dependencies ==="
              apt-get update
              apt-get install -y \
                build-essential \
                cmake \
                ninja-build \
                git \
                pkg-config \
                libavcodec-dev \
                libavformat-dev \
                libavutil-dev \
                libswscale-dev \
                libxi-dev \
                libxrandr-dev \
                libevdev-dev \
                libsfml-dev \
                libminiupnpc-dev \
                libmbedtls-dev \
                libcurl4-openssl-dev \
                libhidapi-dev \
                libsystemd-dev \
                libbluetooth-dev \
                libasound2-dev \
                libpulse-dev \
                libpugixml-dev \
                libbz2-dev \
                libzstd-dev \
                liblzo2-dev \
                libpng-dev \
                libusb-1.0-0-dev \
                libfmt-dev \
                qt6-base-dev \
                qt6-base-private-dev \
                libqt6svg6-dev \
                libxxhash-dev \
                libspng-dev \
                libxcb-cursor0 \
                dpkg-dev \
                fakeroot

              echo "=== Cloning Dolphin ==="
              cd /tmp
              git clone https://github.com/dolphin-emu/dolphin.git
              cd dolphin
              git checkout "$COMMIT"
              git submodule update --init --recursive

              echo "=== Configuring build ==="
              mkdir build && cd build
              cmake .. \
                -G Ninja \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=/usr \
                -DCMAKE_CXX_FLAGS="-mcpu=cortex-a57" \
                -DENABLE_VULKAN=ON \
                -DENABLE_X11=OFF \
                -DENABLE_WAYLAND=ON \
                -DENABLE_TESTS=OFF \
                -DENABLE_ANALYTICS=OFF

              echo "=== Building ==="
              ninja -j$(nproc)

              echo "=== Creating .deb package ==="
              DESTDIR=/tmp/dolphin-pkg ninja install

              # Use short SHA as version
              PKG_VERSION="git-${SHORT_SHA}"

              mkdir -p /tmp/dolphin-pkg/DEBIAN
              cat > /tmp/dolphin-pkg/DEBIAN/control << EOF
          Package: dolphin-emu-l4t
          Version: ${PKG_VERSION}
          Architecture: arm64
          Maintainer: Ethiquema <noreply@ethiquema.github.io>
          Depends: libc6, libqt6widgets6, libqt6gui6, libqt6core6, libavcodec60, libavformat60, libswscale7, libevdev2, libminiupnpc17, libmbedtls21, libcurl4t64, libhidapi-hidraw0, libsystemd0, libbluetooth3, libasound2t64, libpulse0, libpugixml1v5, libbz2-1.0, libzstd1, liblzo2-2, libpng16-16t64, libusb-1.0-0, libfmt9, libsfml-system2.6, libsfml-network2.6, libxxhash0, libspng0
          Section: games
          Priority: optional
          Description: Dolphin GameCube/Wii Emulator (ARM64 L4T build)
           Dolphin is an emulator for GameCube and Wii games.
           This build is optimized for Nintendo Switch L4T with Vulkan/Wayland support.
          EOF

              dpkg-deb --build /tmp/dolphin-pkg /workspace/dolphin-emu-l4t_${PKG_VERSION}_arm64.deb
              echo "=== Build complete ==="
            '

      - name: Save commit tracker
        if: steps.check.outputs.should_build == 'true'
        run: |
          echo "${{ steps.check.outputs.commit }}" > .dolphin-commit

      - name: Checkout gh-pages
        if: steps.check.outputs.should_build == 'true'
        run: |
          git fetch origin gh-pages:gh-pages || true
          git worktree add gh-pages-dir gh-pages || {
            git worktree add --detach gh-pages-dir
            cd gh-pages-dir
            git checkout --orphan gh-pages
            git rm -rf . 2>/dev/null || true
            mkdir -p pool/main dists/noble/main/binary-arm64
            cd ..
          }

      - name: Install APT tools
        if: steps.check.outputs.should_build == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils

      - name: Import GPG key
        if: steps.check.outputs.should_build == 'true'
        run: |
          echo "${{ secrets.PRIVATE }}" | gpg --batch --import
          gpg --armor --export "Ethiquema L4T Repo" > gh-pages-dir/public.key

      - name: Add package to pool
        if: steps.check.outputs.should_build == 'true'
        run: |
          mkdir -p gh-pages-dir/pool/main
          cp dolphin-emu-l4t_*_arm64.deb gh-pages-dir/pool/main/

      - name: Regenerate APT repository metadata
        if: steps.check.outputs.should_build == 'true'
        run: |
          cd gh-pages-dir
          mkdir -p dists/noble/main/binary-arm64

          dpkg-scanpackages --arch arm64 pool/ > dists/noble/main/binary-arm64/Packages
          gzip -k -f dists/noble/main/binary-arm64/Packages

          cd dists/noble
          cat > Release << EOF
          Origin: Ethiquema L4T Repository
          Label: l4t-debs
          Suite: noble
          Codename: noble
          Architectures: arm64
          Components: main
          Description: L4T packages for Nintendo Switch
          EOF

          apt-ftparchive release . >> Release
          rm -f Release.gpg InRelease
          gpg --batch --default-key "Ethiquema L4T Repo" -abs -o Release.gpg Release
          gpg --batch --default-key "Ethiquema L4T Repo" --clearsign -o InRelease Release

      - name: Deploy to gh-pages
        if: steps.check.outputs.should_build == 'true'
        run: |
          cd gh-pages-dir
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Add Dolphin git-${{ steps.check.outputs.short_sha }} ARM64" || echo "No changes"
          git push origin gh-pages

      - name: Save tracker to main
        if: steps.check.outputs.should_build == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .dolphin-commit
          git commit -m "Update Dolphin commit tracker" || echo "No changes"
          git push origin main
